<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="fw-bold mb-1">Admin Panel</h2>
                    <p class="text-muted mb-0">Manage users and activities</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Stats -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center">
                <div class="card-body">
                    <h3 class="text-primary mb-1" id="totalUsers">0</h3>
                    <p class="text-muted mb-0">Total Users</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center">
                <div class="card-body">
                    <h3 class="text-success mb-1" id="totalActivities">0</h3>
                    <p class="text-muted mb-0">Total Activities</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center">
                <div class="card-body">
                    <h3 class="text-warning mb-1" id="activeToday">0</h3>
                    <p class="text-muted mb-0">Active Today</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center">
                <div class="card-body">
                    <h3 class="text-info mb-1" id="avgCompletion">0%</h3>
                    <p class="text-muted mb-0">Avg Completion</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                <i class="fas fa-users me-2"></i>User Management
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="activities-tab" data-bs-toggle="tab" data-bs-target="#activities" type="button" role="tab">
                <i class="fas fa-running me-2"></i>Activity Management
            </button>
        </li>
    </ul>

    <div class="tab-content" id="adminTabContent">
        <!-- User Management Tab -->
        <div class="tab-pane fade show active" id="users" role="tabpanel">
            <div class="card border-0 shadow-sm mt-3">
                <div class="card-header bg-light border-0">
                    <h5 class="mb-0">Registered Users</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Joined</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr>
                                    <td colspan="5" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Management Tab -->
        <div class="tab-pane fade" id="activities" role="tabpanel">
            <div class="card border-0 shadow-sm mt-3">
                <div class="card-header bg-light border-0 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">System Activities</h5>
                    <button class="btn btn-primary btn-sm" onclick="showAddActivityModal()">
                        <i class="fas fa-plus me-1"></i>Add Activity
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Description</th>
                                    <th>Type</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="activitiesTableBody">
                                <tr>
                                    <td colspan="5" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadAdminData();
});

async function loadAdminData() {
    try {
        await Promise.all([
            loadUsers(),
            loadActivities(),
            loadAdminStats()
        ]);
    } catch (error) {
        console.error('Error loading admin data:', error);
    }
}

async function loadUsers() {
    try {
        const response = await fetch('/api/admin/users');
        if (response.ok) {
            const users = await response.json();
            renderUsersTable(users);
        }
    } catch (error) {
        console.error('Error loading users:', error);
    }
}

async function loadActivities() {
    try {
        const response = await fetch('/api/activities');
        if (response.ok) {
            const activities = await response.json();
            renderActivitiesTable(activities);
        }
    } catch (error) {
        console.error('Error loading activities:', error);
    }
}

async function loadAdminStats() {
    // Mock stats for demo
    document.getElementById('totalUsers').textContent = '12';
    document.getElementById('totalActivities').textContent = '24';
    document.getElementById('activeToday').textContent = '8';
    document.getElementById('avgCompletion').textContent = '73%';
}

function renderUsersTable(users) {
    const tbody = document.getElementById('usersTableBody');
    if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">No users found</td></tr>';
        return;
    }

    tbody.innerHTML = users.map(user => `
        <tr>
            <td>${user.firstName || ''} ${user.lastName || ''}</td>
            <td>${user.email}</td>
            <td>
                <span class="badge ${user.role === 'admin' ? 'bg-danger' : 'bg-secondary'}">${user.role}</span>
            </td>
            <td>${new Date(user.createdAt).toLocaleDateString()}</td>
            <td>
                ${user.role !== 'admin' ? `
                    <button class="btn btn-sm btn-outline-primary" onclick="promoteUser('${user.id}')">
                        Make Admin
                    </button>
                ` : ''}
            </td>
        </tr>
    `).join('');
}

function renderActivitiesTable(activities) {
    const tbody = document.getElementById('activitiesTableBody');
    if (activities.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">No activities found</td></tr>';
        return;
    }

    tbody.innerHTML = activities.map(activity => `
        <tr>
            <td>${activity.title}</td>
            <td>
                <span class="badge category-${activity.category}">${activity.category}</span>
            </td>
            <td class="text-truncate" style="max-width: 200px;">${activity.description}</td>
            <td>
                <span class="badge ${activity.isCustom ? 'bg-warning' : 'bg-info'}">
                    ${activity.isCustom ? 'Custom' : 'System'}
                </span>
            </td>
            <td>
                ${activity.isCustom ? `
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteActivity(${activity.id})">
                        Delete
                    </button>
                ` : ''}
            </td>
        </tr>
    `).join('');
}

async function promoteUser(userId) {
    if (!confirm('Are you sure you want to make this user an admin?')) {
        return;
    }

    try {
        const response = await fetch(`/api/admin/users/${userId}/role`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ role: 'admin' })
        });

        if (response.ok) {
            showAlert('User promoted to admin successfully!', 'success');
            loadUsers();
        }
    } catch (error) {
        console.error('Error promoting user:', error);
        showAlert('Failed to promote user', 'danger');
    }
}

async function deleteActivity(activityId) {
    if (!confirm('Are you sure you want to delete this activity?')) {
        return;
    }

    try {
        const response = await fetch(`/api/activities/${activityId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            showAlert('Activity deleted successfully!', 'success');
            loadActivities();
        }
    } catch (error) {
        console.error('Error deleting activity:', error);
        showAlert('Failed to delete activity', 'danger');
    }
}

function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        if (alertDiv && alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>