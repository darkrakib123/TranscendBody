<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Transcend Your Body</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/themes.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <meta name="description" content="Track your daily fitness activities across workout, nutrition, recovery, and mindset dimensions.">
    <meta name="theme-color" content="#667eea">
</head>
<body class="bg-light">
<script>
  window.currentUser = {
    id: '<%= user.id %>',
    plan: '<%= user.plan %>',
    tier: '<%= user.tier %>',
    accountabilityLevel: '<%= user.accountabilityLevel %>',
    role: '<%= user.role %>'
  };
</script>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay d-none">
  <div class="loading-spinner">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3 text-muted">Loading your dashboard...</p>
  </div>
</div>

<div class="container mx-auto py-4" style="max-width: 1200px;">
  <!-- Enhanced Header with Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white rounded-4 shadow-sm mb-4 px-4 py-3">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold text-primary" href="/dashboard">
        <i class="fas fa-dumbbell me-2"></i>TranscendBody
      </a>
      
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link active" href="/dashboard">
              <i class="fas fa-tachometer-alt me-1"></i>Dashboard
            </a>
          </li>
        </ul>
        
        <ul class="navbar-nav">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown">
              <div class="avatar-circle me-2">
                <%= (user.preferredName || user.firstName || user.email).charAt(0).toUpperCase() %>
              </div>
              <%= user.preferredName || user.firstName || 'User' %>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><h6 class="dropdown-header">
                <%= user.email %>
                <br><small class="text-muted"><%= user.tier %> â€¢ <%= user.accountabilityLevel %></small>
              </h6></li>
              <li><hr class="dropdown-divider"></li>
              <% if (user.role === 'admin') { %>
                <li><a class="dropdown-item" href="/admin">
                  <i class="fas fa-cog me-2"></i>Admin Panel
                </a></li>
                <li><hr class="dropdown-divider"></li>
              <% } %>
              <li><a class="dropdown-item" href="#" onclick="showSettingsModal()">
                <i class="fas fa-cog me-2"></i>Settings
              </a></li>
              <li><a class="dropdown-item text-danger" href="/logout">
                <i class="fas fa-sign-out-alt me-2"></i>Logout
              </a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Header -->
  <div class="hero-card card shadow-lg rounded-4 mb-4 p-4 position-relative overflow-hidden">
    <div class="row align-items-center g-0 flex-column flex-md-row">
      <div class="col-md-7 d-flex flex-column justify-content-center align-items-start text-white">
        <div class="welcome-text">
          <h1 class="display-4 fw-bold mb-2 animate-fade-in">
            Welcome back, <%= user.preferredName || user.firstName || 'User' %>!
          </h1>
          <div class="fs-5 text-white-75 mb-3 animate-fade-in-delay">
            Your Daily Activities Dashboard <span id="currentDate" class="fw-medium"></span>
          </div>
          
          <!-- Quick Stats Preview -->
          <div class="row g-3 mt-2">
            <div class="col-6 col-md-4">
              <div class="stat-preview text-center">
                <div class="stat-number" id="headerStreak">0</div>
                <div class="stat-label">Day Streak</div>
              </div>
            </div>
            <div class="col-6 col-md-4">
              <div class="stat-preview text-center">
                <div class="stat-number" id="headerCompletion">0%</div>
                <div class="stat-label">Today</div>
              </div>
            </div>
            <div class="col-12 col-md-4">
              <div class="stat-preview text-center">
                <div class="stat-number" id="headerTotal">0</div>
                <div class="stat-label">Total Activities</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-5 d-flex flex-column align-items-center justify-content-center mt-4 mt-md-0">
        <!-- Enhanced Daily Completion Rate Card -->
        <div class="completion-card card border-0 shadow-lg p-4 mb-2 bg-white position-relative mx-auto">
          <div class="text-center fw-bold fs-5 mb-3 text-dark">
            Daily Completion Rate
            <i class="fas fa-info-circle text-primary ms-1" data-bs-toggle="tooltip" 
               title="Complete at least 80% of today's activities to maintain your streak!"></i>
          </div>
          
          <div class="d-flex justify-content-center align-items-center">
            <div class="progress-circle position-relative d-flex flex-column justify-content-center align-items-center">
              <svg width="160" height="160" viewBox="0 0 160 160" class="progress-svg">
                <circle cx="80" cy="80" r="70" stroke="#e9ecef" stroke-width="8" fill="none"/>
                <circle id="completionBar" cx="80" cy="80" r="70" stroke="#2563eb" stroke-width="8" 
                        fill="none" stroke-linecap="round" stroke-dasharray="439.8" stroke-dashoffset="439.8"
                        class="progress-circle-bar"/>
              </svg>
              
              <div class="position-absolute top-50 start-50 translate-middle text-center">
                <div class="completion-percentage display-4 fw-bold text-primary" id="completionPercentage">0%</div>
                <div class="completion-label text-muted">Complete</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Animated background elements -->
    <div class="hero-bg-elements">
      <div class="bg-element bg-element-1"></div>
      <div class="bg-element bg-element-2"></div>
      <div class="bg-element bg-element-3"></div>
    </div>
  </div>

  <!-- Enhanced Level & Tier Cards -->
  <div class="row g-4 mb-4">
    <!-- Accountability Level Card -->
    <div class="col-12 col-md-6">
      <div class="level-card card shadow-sm rounded-4 p-4 text-center h-100 level-<%= user.accountabilityLevel %>">
        <div class="d-flex flex-column align-items-center justify-content-center h-100">
          <div class="level-icon mb-3">
            <% if (user.accountabilityLevel === 'master') { %>
              <i class="fas fa-crown"></i>
            <% } else if (user.accountabilityLevel === 'intermediate') { %>
              <i class="fas fa-medal"></i>
            <% } else { %>
              <i class="fas fa-star"></i>
            <% } %>
          </div>
          <h3 class="fw-bold mb-2 text-capitalize"><%= user.accountabilityLevel %></h3>
          <p class="text-muted mb-0">
            <% if (user.accountabilityLevel === 'master') { %>
              You've mastered the system!
            <% } else if (user.accountabilityLevel === 'intermediate') { %>
              Making great progress!
            <% } else { %>
              Building strong habits!
            <% } %>
          </p>
        </div>
      </div>
    </div>

    <!-- Tier Card -->
    <div class="col-12 col-md-6">
      <div class="tier-card card shadow-sm rounded-4 p-4 text-center h-100 tier-<%= user.tier %>">
        <div class="d-flex flex-column align-items-center justify-content-center h-100">
          <div class="tier-icon mb-3">
            <i class="fas fa-trophy"></i>
          </div>
          <h3 class="fw-bold mb-2 text-capitalize"><%= user.tier %> Tier</h3>
          <p class="text-muted mb-0">
            <% if (user.tier === 'gold') { %>
              Highest tier achieved!
            <% } else if (user.tier === 'silver') { %>
              Great consistency!
            <% } else { %>
              Keep building momentum!
            <% } %>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced Quick Stats Grid -->
  <div class="row g-4 mb-4">
    <div class="col-6 col-lg-3">
      <div class="stat-card card border-0 shadow-sm rounded-4 p-4 text-center h-100">
        <div class="stat-icon mb-3">
          <i class="fas fa-fire text-danger"></i>
        </div>
        <div class="stat-value fw-bold mb-1" id="currentStreak">0</div>
        <div class="stat-label text-muted">Day Streak</div>
        <div class="stat-sublabel">Consecutive days</div>
      </div>
    </div>
    
    <div class="col-6 col-lg-3">
      <div class="stat-card card border-0 shadow-sm rounded-4 p-4 text-center h-100">
        <div class="stat-icon mb-3">
          <i class="fas fa-calendar-week text-success"></i>
        </div>
        <div class="stat-value fw-bold mb-1" id="weeklyAverage">0%</div>
        <div class="stat-label text-muted">Weekly Avg</div>
        <div class="stat-sublabel">Aim for 80%+</div>
      </div>
    </div>
    
    <div class="col-6 col-lg-3">
      <div class="stat-card card border-0 shadow-sm rounded-4 p-4 text-center h-100">
        <div class="stat-icon mb-3">
          <i class="fas fa-check-circle text-primary"></i>
        </div>
        <div class="stat-value fw-bold mb-1" id="totalActivities">0</div>
        <div class="stat-label text-muted">Completed</div>
        <div class="stat-sublabel">All time</div>
      </div>
    </div>
    
    <div class="col-6 col-lg-3">
      <div class="stat-card card border-0 shadow-sm rounded-4 p-4 text-center h-100">
        <div class="stat-icon mb-3">
          <i class="fas fa-target text-warning"></i>
        </div>
        <div class="stat-value fw-bold mb-1" id="accountabilityScore"><%= accountabilityCountdown || 0 %></div>
        <div class="stat-label text-muted">Days to Next</div>
        <div class="stat-sublabel">Level/Tier</div>
      </div>
    </div>
  </div>

  <!-- ACTIVITY TIME SLOTS: Responsive Add Activity button and badge -->
  <% const slots = [
    { key: 'morning', icon: 'fa-sun', color: 'morning', label: 'Morning', desc: 'Start your day right', time: '6:00 - 12:00' },
    { key: 'afternoon', icon: 'fa-sun', color: 'afternoon', label: 'Afternoon', desc: 'Keep the momentum going', time: '12:00 - 18:00' },
    { key: 'evening', icon: 'fa-moon', color: 'evening', label: 'Evening', desc: 'Wind down and recover', time: '18:00 - 22:00' },
    { key: 'night', icon: 'fa-star', color: 'night', label: 'Night', desc: 'Reflect and prepare for tomorrow', time: '22:00 - 6:00' }
  ]; %>
  
  <% slots.forEach(slot => { %>
  <div class="time-slot-card card shadow-sm rounded-4 mb-4 p-4 slot-<%= slot.color %>">
    <div class="slot-header d-flex flex-wrap align-items-center justify-content-between mb-4 gap-3">
      <div class="slot-info d-flex align-items-center flex-grow-1 min-w-0">
        <div class="slot-icon rounded-circle d-flex align-items-center justify-content-center me-3">
          <i class="fas <%= slot.icon %>"></i>
        </div>
        <div class="slot-details min-w-0">
          <h4 class="slot-title mb-1"><%= slot.label %></h4>
          <p class="slot-description text-muted mb-0"><%= slot.desc %></p>
          <small class="slot-time text-muted"><%= slot.time %></small>
        </div>
      </div>
      
      <div class="slot-actions d-flex flex-column flex-md-row align-items-md-center align-items-stretch gap-2">
        <div class="progress-badge" id="<%= slot.key %>-progress">0 of 0 completed</div>
        <button class="btn btn-primary btn-sm rounded-pill add-activity-btn" onclick="showAddActivityModal('<%= slot.key %>')">
          <i class="fas fa-plus me-1"></i> Add Activity
        </button>
      </div>
    </div>
    
    <div class="slot-activities" id="<%= slot.key %>-activities">
      <!-- Activities will be loaded dynamically -->
    </div>
  </div>
  <% }); %>
</div>

<!-- Enhanced Add Activity Modal -->
<div class="modal fade" id="addActivityModal" tabindex="-1" aria-labelledby="addActivityModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addActivityModalLabel">
          <i class="fas fa-plus-circle me-2"></i>Add New Activity
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body">
        <form id="addActivityForm">
          <div class="mb-3">
            <label for="activitySelect" class="form-label fw-semibold">Choose Activity</label>
            <select class="form-select" id="activitySelect" name="activityId">
              <option value="">Loading activities...</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="timeSlot" class="form-label fw-semibold">Assign to Time Slot</label>
            <select class="form-select" id="timeSlot" name="timeSlot" required>
              <option value="morning">Morning</option>
              <option value="afternoon">Afternoon</option>
              <option value="evening">Evening</option>
              <option value="night">Night</option>
            </select>
          </div>
          
          <div class="mb-3">
            <button type="button" class="btn btn-outline-primary w-100" id="showCustomActivityFields">
              <i class="fas fa-plus me-2"></i>Create Custom Activity
            </button>
          </div>
          
          <div id="customActivityFields" style="display: none;">
            <hr class="my-4">
            <h6 class="fw-semibold mb-3">Custom Activity Details</h6>
            
            <div class="mb-3">
              <label for="customTitle" class="form-label fw-semibold">Activity Title *</label>
              <input type="text" class="form-control" id="customTitle" name="customTitle" 
                     placeholder="e.g., 30-minute walk">
            </div>
            
            <div class="mb-3">
              <label for="customDescription" class="form-label">Description</label>
              <textarea class="form-control" id="customDescription" name="customDescription" rows="3"
                        placeholder="Describe your custom activity..."></textarea>
            </div>
            
            <div class="mb-3">
              <label for="customCategory" class="form-label fw-semibold">Category *</label>
              <select class="form-select" id="customCategory" name="customCategory" required>
                <option value="">Select category</option>
                <option value="workout">Workout</option>
                <option value="nutrition">Nutrition</option>
                <option value="recovery">Recovery</option>
                <option value="mindset">Mindset</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="customTimeSlot" class="form-label fw-semibold">Preferred Time Slot *</label>
              <select class="form-select" id="customTimeSlot" name="customTimeSlot" required>
                <option value="">Select time slot</option>
                <option value="morning">Morning</option>
                <option value="afternoon">Afternoon</option>
                <option value="evening">Evening</option>
                <option value="night">Night</option>
              </select>
            </div>
          </div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="addActivity()">
          <i class="fas fa-plus me-1"></i>Add Activity
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="settingsModalLabel">
          <i class="fas fa-cog me-2"></i>Settings
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="settingsForm">
          <div class="mb-3">
            <label for="themeSelect" class="form-label fw-semibold">Theme</label>
            <select class="form-select" id="themeSelect">
              <option value="light">Light</option>
              <option value="dark">Dark</option>
              <option value="auto">Auto</option>
            </select>
          </div>
          
          <div class="mb-3">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="notificationsToggle" checked>
              <label class="form-check-label" for="notificationsToggle">
                Enable Notifications
              </label>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="timezoneSelect" class="form-label fw-semibold">Timezone</label>
            <select class="form-select" id="timezoneSelect">
              <option value="UTC">UTC</option>
              <option value="America/New_York">Eastern Time</option>
              <option value="America/Chicago">Central Time</option>
              <option value="America/Denver">Mountain Time</option>
              <option value="America/Los_Angeles">Pacific Time</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveSettings()">
          <i class="fas fa-save me-1"></i>Save Settings
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Success Toast -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <i class="fas fa-check-circle text-success me-2"></i>
      <strong class="me-auto">Success</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
    </div>
    <div class="toast-body">
      <!-- Toast message will be inserted here -->
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/app.js"></script>

<script>
// Settings modal functionality
function showSettingsModal() {
  const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
  modal.show();
}

function saveSettings() {
  // Implementation for saving settings
  const theme = document.getElementById('themeSelect').value;
  const notifications = document.getElementById('notificationsToggle').checked;
  const timezone = document.getElementById('timezoneSelect').value;
  
  // Save to localStorage for now (could be enhanced to save to server)
  localStorage.setItem('userSettings', JSON.stringify({
    theme,
    notifications,
    timezone
  }));
  
  // Apply theme immediately
  document.body.setAttribute('data-theme', theme);
  
  // Close modal and show success message
  bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
  showAlert('Settings saved successfully!', 'success');
}

// Load saved settings on page load
document.addEventListener('DOMContentLoaded', function() {
  const savedSettings = localStorage.getItem('userSettings');
  if (savedSettings) {
    const settings = JSON.parse(savedSettings);
    document.getElementById('themeSelect').value = settings.theme || 'light';
    document.getElementById('notificationsToggle').checked = settings.notifications !== false;
    document.getElementById('timezoneSelect').value = settings.timezone || 'UTC';
    
    // Apply saved theme
    document.body.setAttribute('data-theme', settings.theme || 'light');
  }
});
</script>
</body>
</html> 